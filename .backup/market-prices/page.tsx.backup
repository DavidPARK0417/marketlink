/**
 * @file app/wholesaler/market-prices/page.tsx
 * @description ì‹œì„¸ ì¡°íšŒ í˜ì´ì§€
 *
 * ì‹¤ì‹œê°„ ë†ìˆ˜ì‚°ë¬¼ ê²½ë§¤ê°€ê²©ì„ ì¡°íšŒí•˜ëŠ” í˜ì´ì§€ì…ë‹ˆë‹¤.
 * ê³µê³µë°ì´í„°í¬í„¸ APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜¨ë¼ì¸ ë„ë§¤ì‹œì¥ ê±°ë˜ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
 *
 * ì£¼ìš” ê¸°ëŠ¥:
 * 1. ì‹¤ì‹œê°„ ì‹œì„¸ ì¡°íšŒ
 * 2. ìƒí’ˆë³„ ì‹œì„¸ ê²€ìƒ‰ (ëŒ€ë¶„ë¥˜/ì¤‘ë¶„ë¥˜/ì†Œë¶„ë¥˜ ì½”ë“œ ê¸°ë°˜)
 * 3. ì‹œì„¸ í…Œì´ë¸” í‘œì‹œ
 *
 * @dependencies
 * - components/common/PageHeader.tsx
 * - components/wholesaler/MarketPrices/PriceFilter.tsx
 * - components/wholesaler/MarketPrices/PriceTable.tsx
 * - hooks/use-market-prices.ts
 */

"use client";

import { useState, useMemo } from "react";
import PageHeader from "@/components/common/PageHeader";
import PriceFilter, {
  type PriceFilterParams,
} from "@/components/wholesaler/MarketPrices/PriceFilter";
import PriceTable from "@/components/wholesaler/MarketPrices/PriceTable";
import { useMarketPrices } from "@/hooks/use-market-prices";
import { getCategoryFromKeyword } from "@/lib/api/market-prices-utils";
import type { MarketPriceParams } from "@/lib/api/market-prices-types";
import { AlertCircle, Search } from "lucide-react";

export default function MarketPricesPage() {
  // ğŸ”¥ nullë¡œ ì´ˆê¸°í™” (ê²€ìƒ‰ ì „ì—ëŠ” API í˜¸ì¶œ ì•ˆ í•¨)
  const [searchParams, setSearchParams] = useState<PriceFilterParams | null>(
    null,
  );
  const [hasSearched, setHasSearched] = useState(false); // ğŸ†• ê²€ìƒ‰ ì—¬ë¶€ ì¶”ì 

  // ì‹œì„¸ ì¡°íšŒ (searchParamsê°€ ìˆì„ ë•Œë§Œ)
  const apiParams = useMemo(() => {
    if (!searchParams) return null; // ğŸ”¥ nullì´ë©´ API í˜¸ì¶œ ì•ˆ í•¨

    // KAMIS API íŒŒë¼ë¯¸í„° ì„¤ì •
    // ë‚ ì§œ ë²”ìœ„: ìµœê·¼ 30ì¼ (ë” ë§ì€ ë°ì´í„° í™•ë³´)
    const today = new Date();
    const monthAgo = new Date(today);
    monthAgo.setDate(today.getDate() - 30);

    const startDay = monthAgo.toISOString().split("T")[0]; // YYYY-MM-DD
    const endDay = today.toISOString().split("T")[0];

    const params: MarketPriceParams = {
      // KAMIS API íŒŒë¼ë¯¸í„°
      itemName: searchParams.searchKeyword,
      countryCode: searchParams.countryCode,
      startDay: startDay,
      endDay: endDay,
      // ğŸ†• ì½”ë“œí‘œ ê¸°ë°˜ íŒŒë¼ë¯¸í„°
      unitType: searchParams.unitType,
      gradeCode: searchParams.gradeCode,
      productNo: searchParams.productNo,
    };

    console.group("ğŸ” [ì‹œì„¸ ì¡°íšŒ] KAMIS API ê²€ìƒ‰");
    console.log("í’ˆëª©ëª…:", searchParams.searchKeyword || "ì „ì²´");
    console.log("ì§€ì—­ ì½”ë“œ:", searchParams.countryCode || "ì „ì²´");
    console.log("ë‚ ì§œ ë²”ìœ„:", startDay, "~", endDay);
    console.groupEnd();

    return params;
  }, [searchParams]);

  const {
    data: allPrices,
    isLoading,
    error,
  } = useMarketPrices(apiParams || {}); // ğŸ”¥ nullì´ë©´ ë¹ˆ ê°ì²´ ì „ë‹¬

  // KAMIS APIëŠ” ì„œë²„ì—ì„œ í•„í„°ë§í•˜ë¯€ë¡œ í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§ ìµœì†Œí™”
  const filteredPrices = useMemo(() => {
    if (!allPrices || !searchParams) return [];

    // KAMIS APIê°€ ì´ë¯¸ í•„í„°ë§ëœ ê²°ê³¼ë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ
    // ì¶”ê°€ í•„í„°ë§ì€ ìµœì†Œí•œìœ¼ë¡œë§Œ ìˆ˜í–‰
    let filtered = allPrices;

    // í’ˆëª©ëª…ì´ ì •í™•íˆ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê²½ìš°ë¥¼ ìœ„í•œ ë³´ì¡° í•„í„°ë§
    if (searchParams.searchKeyword) {
      const keyword = searchParams.searchKeyword.toLowerCase().trim();
      filtered = filtered.filter((item) => {
        const itemName = item.itemName.toLowerCase();
        const varietyName = item.varietyName.toLowerCase();
        return itemName.includes(keyword) || varietyName.includes(keyword);
      });
    }

    return filtered;
  }, [allPrices, searchParams]);

  const handleSearch = (params: PriceFilterParams) => {
    console.group("ğŸ” [ì‹œì„¸ ì¡°íšŒ] ê²€ìƒ‰ íŒŒë¼ë¯¸í„°");
    console.log("í’ˆëª©ëª…:", params.searchKeyword || "ì „ì²´");

    if (params.searchKeyword) {
      const category = getCategoryFromKeyword(params.searchKeyword);
      if (category) {
        console.log("ìë™ ì„¤ì •ëœ ëŒ€ë¶„ë¥˜ ì½”ë“œ:", category.lclsfCd);
      } else {
        console.log("âš ï¸ ë§¤í•‘ëœ ì¹´í…Œê³ ë¦¬ ì—†ìŒ - ì „ì²´ ë°ì´í„° ì¡°íšŒ í›„ í•„í„°ë§");
      }
    }
    console.groupEnd();

    setSearchParams(params);
    setHasSearched(true); // ğŸ†• ê²€ìƒ‰ ì‹¤í–‰ë¨
  };

  const hasError = !!error;

  return (
    <div className="flex flex-col gap-4 -mx-6 -my-6">
      <div className="px-6 md:px-8 pt-6 md:pt-8">
        <PageHeader
          title="ì‹œì„¸ ì¡°íšŒ"
          description="ì „êµ­ ë†ìˆ˜ì‚°ë¬¼ ê²½ë§¤ê°€ê²©ì„ ì§€ì—­ë³„, í’ˆëª©ë³„ë¡œ í™•ì¸í•˜ì„¸ìš”."
          hideTitle={true}
        />
      </div>

      {/* ğŸ†• ê²€ìƒ‰ í•„í„° - ìƒë‹¨ ì „ì²´ ë„ˆë¹„ */}
      <div className="border-b bg-card">
        <PriceFilter onSearch={handleSearch} isLoading={isLoading} />
      </div>

      {/* ì—ëŸ¬ í‘œì‹œ */}
      {hasError && (
        <div className="mx-6 md:mx-8 border border-destructive bg-destructive/10 p-4">
          <div className="flex gap-2">
            <AlertCircle className="size-5 text-destructive" />
            <div className="flex flex-col gap-1">
              <h3 className="font-semibold text-destructive">ì‹œì„¸ ì¡°íšŒ ì˜¤ë¥˜</h3>
              <p className="text-sm text-destructive/80">
                {error?.message || "ì‹œì„¸ë¥¼ ì¡°íšŒí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."}
              </p>
            </div>
          </div>
        </div>
      )}

      {/* ğŸ†• ì´ˆê¸° ìƒíƒœ ë©”ì‹œì§€ */}
      {!hasSearched && !isLoading && (
        <div className="flex flex-col items-center justify-center p-12 gap-4">
          <Search className="size-12 text-muted-foreground" />
          <div className="text-center">
            <h3 className="text-lg font-semibold mb-2">
              ì‹œì„¸ ì¡°íšŒë¥¼ ì‹œì‘í•˜ì„¸ìš”
            </h3>
            <p className="text-sm text-muted-foreground">
              í’ˆëª©ëª…ì„ ì…ë ¥í•œ í›„{" "}
              <span className="font-semibold">ì‹œì„¸ ì¡°íšŒ</span> ë²„íŠ¼ì„
              ëˆŒëŸ¬ì£¼ì„¸ìš”.
            </p>
          </div>
        </div>
      )}

      {/* ê²€ìƒ‰ ê²°ê³¼ ìš”ì•½ */}
      {hasSearched && !isLoading && filteredPrices.length > 0 && (
        <div className="px-6 md:px-8 text-sm text-muted-foreground">
          ì´{" "}
          <span className="font-semibold text-foreground">
            {filteredPrices.length}ê°œ
          </span>
          ì˜ ì‹œì„¸ ì •ë³´ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.
        </div>
      )}

      {/* ì‹œì„¸ í…Œì´ë¸” - ê²€ìƒ‰ í›„ì—ë§Œ í‘œì‹œ */}
      {hasSearched && (
        <div className="flex-1 overflow-hidden">
          <div className="h-full flex flex-col">
            <div className="px-6 md:px-8 py-4 border-b">
              <h2 className="text-lg font-semibold">ì‹œì„¸ ëª©ë¡</h2>
            </div>
            <div className="flex-1 overflow-auto">
              <PriceTable data={filteredPrices} isLoading={isLoading} />
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
