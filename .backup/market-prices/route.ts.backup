/**
 * @file app/api/market-prices/route.ts
 * @description ì‹œì„¸ ì¡°íšŒ API Route
 *
 * KAMIS Open APIë¥¼ ì„œë²„ ì‚¬ì´ë“œì—ì„œ í˜¸ì¶œí•˜ì—¬ CORS ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤.
 * í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì´ API Routeë¥¼ í†µí•´ ì‹œì„¸ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
 *
 * @dependencies
 * - lib/api/market-prices.ts
 */

import { NextResponse } from "next/server";
import { getMarketPrices } from "@/lib/api/market-prices";
import type { MarketPriceParams } from "@/lib/api/market-prices-types";

/**
 * GET /api/market-prices
 * ì‹œì„¸ ì¡°íšŒ (KAMIS API)
 */
export async function GET(request: Request) {
  const requestId = Date.now().toString(36);
  
  try {
    const { searchParams } = new URL(request.url);

    // KAMIS API íŒŒë¼ë¯¸í„° ì¶”ì¶œ
    const params: MarketPriceParams = {
      // KAMIS API íŒŒë¼ë¯¸í„°
      itemName: searchParams.get("itemName") || undefined,
      countryCode: searchParams.get("countryCode") || undefined,
      itemCategoryCode: searchParams.get("itemCategoryCode") || undefined,
      itemCode: searchParams.get("itemCode") || undefined,
      kindCode: searchParams.get("kindCode") || undefined,
      productRankCode: searchParams.get("productRankCode") || undefined,
      startDay: searchParams.get("startDay") || undefined,
      endDay: searchParams.get("endDay") || undefined,
      
      // í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•œ ë ˆê±°ì‹œ íŒŒë¼ë¯¸í„°
      date: searchParams.get("date") || undefined,
      dateRange: searchParams.get("dateFrom") && searchParams.get("dateTo")
        ? { from: searchParams.get("dateFrom")!, to: searchParams.get("dateTo")! }
        : undefined,
      lclsfCd: searchParams.get("lclsfCd") || undefined,
      mclsfCd: searchParams.get("mclsfCd") || undefined,
      sclsfCd: searchParams.get("sclsfCd") || undefined,
      whslMrktCd: searchParams.get("whslMrktCd") || undefined,
      pageNo: searchParams.get("pageNo")
        ? parseInt(searchParams.get("pageNo")!)
        : undefined,
      numOfRows: searchParams.get("numOfRows")
        ? parseInt(searchParams.get("numOfRows")!)
        : undefined,
    };

    console.group(`ğŸ“Š [api/market-prices] ì‹œì„¸ ì¡°íšŒ ìš”ì²­ [${requestId}]`);
    console.log("ìš”ì²­ URL:", request.url);
    console.log("íŒŒë¼ë¯¸í„°:", JSON.stringify(params, null, 2));
    console.log("KAMIS íŒŒë¼ë¯¸í„° í™•ì¸:", {
      itemName: params.itemName || "ì—†ìŒ",
      countryCode: params.countryCode || "ì—†ìŒ",
      itemCode: params.itemCode || "ì—†ìŒ",
      itemCategoryCode: params.itemCategoryCode || "ì—†ìŒ",
      startDay: params.startDay || "ì—†ìŒ",
      endDay: params.endDay || "ì—†ìŒ",
    });
    console.log("íƒ€ì„ìŠ¤íƒ¬í”„:", new Date().toISOString());

    const startTime = Date.now();
    const data = await getMarketPrices(params);
    const duration = Date.now() - startTime;

    console.log("âœ… ì‹œì„¸ ì¡°íšŒ ì„±ê³µ:", {
      í•­ëª©ìˆ˜: data.length,
      ì†Œìš”ì‹œê°„: `${duration}ms`,
    });
    console.groupEnd();

    return NextResponse.json({
      success: true,
      data,
      count: data.length,
      requestId,
    });
  } catch (error) {
    // ë” ìì„¸í•œ ì—ëŸ¬ ë¡œê¹…
    console.group(`âŒ [api/market-prices] ì‹œì„¸ ì¡°íšŒ ì‹¤íŒ¨ [${requestId}]`);
    console.error("ì—ëŸ¬ íƒ€ì…:", error instanceof Error ? error.constructor.name : typeof error);
    console.error("ì—ëŸ¬ ë©”ì‹œì§€:", error instanceof Error ? error.message : String(error));
    
    if (error instanceof Error) {
      console.error("ì—ëŸ¬ ìŠ¤íƒ:", error.stack);
      console.error("ì—ëŸ¬ ì´ë¦„:", error.name);
    }
    
    console.error("ìš”ì²­ URL:", request.url);
    console.error("íƒ€ì„ìŠ¤íƒ¬í”„:", new Date().toISOString());
    console.groupEnd();

    // ì—ëŸ¬ ìƒì„¸ ì •ë³´ í¬í•¨
    const errorMessage = error instanceof Error 
      ? error.message 
      : "ì‹œì„¸ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    
    const errorDetails: Record<string, any> = {
      requestId,
      timestamp: new Date().toISOString(),
    };

    if (error instanceof Error && error.stack) {
      errorDetails.stack = error.stack;
    }

    return NextResponse.json(
      {
        success: false,
        error: errorMessage,
        details: errorDetails,
      },
      { status: 500 },
    );
  }
}

