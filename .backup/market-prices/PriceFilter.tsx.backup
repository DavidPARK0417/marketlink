/**
 * @file components/wholesaler/MarketPrices/PriceFilter.tsx
 * @description ì‹œì„¸ ê²€ìƒ‰ í•„í„° ì»´í¬ë„ŒíŠ¸
 *
 * ì‹œì„¸ ì¡°íšŒë¥¼ ìœ„í•œ í•„í„° ì»´í¬ë„ŒíŠ¸ì…ë‹ˆë‹¤.
 * í™•ì •ì¼ì, ëŒ€ë¶„ë¥˜/ì¤‘ë¶„ë¥˜/ì†Œë¶„ë¥˜ ì½”ë“œë¥¼ ì„ íƒí•˜ì—¬ ì‹œì„¸ë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 *
 * ì£¼ìš” ê¸°ëŠ¥:
 * 1. í™•ì •ì¼ì ì„ íƒ
 * 2. ëŒ€ë¶„ë¥˜/ì¤‘ë¶„ë¥˜/ì†Œë¶„ë¥˜ ì„ íƒ
 * 3. ì¸ê¸° í’ˆëª© ë¹ ë¥¸ ê²€ìƒ‰ ë²„íŠ¼
 * 4. Enter í‚¤ë¡œ ê²€ìƒ‰ ì‹¤í–‰
 *
 * @dependencies
 * - components/ui/input, select, button
 * - lib/api/market-prices (itemCategories)
 * - date-fns (ë‚ ì§œ í¬ë§·íŒ…)
 */

"use client";

import { useState, FormEvent, useEffect, useRef } from "react";
import { Search } from "lucide-react";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { kamisCountryCodes } from "@/lib/api/market-prices-utils";
import type { ProductCode } from "@/lib/api/product-codes";

export interface PriceFilterParams {
  searchKeyword?: string; // í’ˆëª©ëª… ê²€ìƒ‰
  countryCode?: string; // ì§€ì—­ ê²½ë§¤ì‹œì¥ ì½”ë“œ
  unitType?: "ì†Œë§¤" | "ë„ë§¤" | "ì†Œí¬ì¥"; // ğŸ†• ë‹¨ìœ„ íƒ€ì… í•„í„°
  gradeCode?: string; // ğŸ†• ë“±ê¸‰ ì½”ë“œ (01: íŠ¹, 02: ìƒ, 03: ì¤‘)
  productNo?: number; // ğŸ†• í’ˆëª©ë²ˆí˜¸
}

interface PriceFilterProps {
  onSearch: (params: PriceFilterParams) => void;
  isLoading?: boolean;
}

export default function PriceFilter({
  onSearch,
  isLoading = false,
}: PriceFilterProps) {
  const [searchKeyword, setSearchKeyword] = useState<string>("");
  const [countryCode, setCountryCode] = useState<string>("");
  const [unitType, setUnitType] = useState<"ì†Œë§¤" | "ë„ë§¤" | "ì†Œí¬ì¥" | "ì „ì²´">(
    "ì „ì²´",
  );
  const [gradeCode, setGradeCode] = useState<string>("ì „ì²´");

  // ğŸ†• ìë™ì™„ì„± ê´€ë ¨ ìƒíƒœ
  const [suggestions, setSuggestions] = useState<ProductCode[]>([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [selectedProductCode, setSelectedProductCode] =
    useState<ProductCode | null>(null);
  const suggestionsRef = useRef<HTMLDivElement>(null);

  // ğŸ†• í’ˆëª©ëª… ìë™ì™„ì„± ê²€ìƒ‰
  useEffect(() => {
    if (searchKeyword.length >= 2) {
      const timer = setTimeout(async () => {
        try {
          const response = await fetch(
            `/api/product-codes/search?keyword=${encodeURIComponent(
              searchKeyword,
            )}&limit=10`,
          );
          if (response.ok) {
            const data = await response.json();
            setSuggestions(data.data || []);
            setShowSuggestions((data.data || []).length > 0);
          }
        } catch (error) {
          console.warn("âš ï¸ [ìë™ì™„ì„±] ê²€ìƒ‰ ì‹¤íŒ¨:", error);
          setSuggestions([]);
          setShowSuggestions(false);
        }
      }, 300); // 300ms ë””ë°”ìš´ìŠ¤

      return () => clearTimeout(timer);
    } else {
      setSuggestions([]);
      setShowSuggestions(false);
    }
  }, [searchKeyword]);

  // ğŸ†• ì™¸ë¶€ í´ë¦­ ì‹œ ìë™ì™„ì„± ë‹«ê¸°
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        suggestionsRef.current &&
        !suggestionsRef.current.contains(event.target as Node)
      ) {
        setShowSuggestions(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const handleSuggestionClick = (code: ProductCode) => {
    setSearchKeyword(code.í’ˆëª©ëª…);
    setSelectedProductCode(code);
    setShowSuggestions(false);
  };

  const handleSubmit = (e: FormEvent<HTMLFormElement>) => {
    e.preventDefault();

    const params: PriceFilterParams = {};
    if (searchKeyword.trim()) params.searchKeyword = searchKeyword.trim();
    if (countryCode) params.countryCode = countryCode;
    if (unitType !== "ì „ì²´") params.unitType = unitType;
    if (gradeCode !== "ì „ì²´") params.gradeCode = gradeCode;
    if (selectedProductCode) params.productNo = selectedProductCode.productNo;

    onSearch(params);
  };

  return (
    <form onSubmit={handleSubmit} className="px-4 md:px-6 py-4 md:py-5">
      <div className="flex flex-col md:flex-row gap-4">
        {/* ì§€ì—­ ê²½ë§¤ì‹œì¥ ì„ íƒ */}
        <div className="flex flex-col gap-2 md:w-48">
          <label htmlFor="country" className="text-sm font-medium">
            ì§€ì—­ ê²½ë§¤ì‹œì¥
          </label>
          <Select
            value={countryCode || undefined}
            onValueChange={(value) => setCountryCode(value || "")}
          >
            <SelectTrigger id="country">
              <SelectValue placeholder="ì „ì²´ ì§€ì—­" />
            </SelectTrigger>
            <SelectContent>
              {Object.entries(kamisCountryCodes)
                .filter(([_, code]) => code !== undefined) // undefinedì¸ í•­ëª© ì œì™¸
                .map(([name, code]) => (
                  <SelectItem key={name} value={code!}>
                    {name}
                  </SelectItem>
                ))}
            </SelectContent>
          </Select>
        </div>

        {/* í’ˆëª©ëª… ê²€ìƒ‰ (ìë™ì™„ì„±) */}
        <div className="flex-1 flex flex-col gap-2">
          <label htmlFor="search" className="text-sm font-medium">
            í’ˆëª©ëª… ê²€ìƒ‰
          </label>
          <div className="relative" ref={suggestionsRef}>
            <Search className="absolute left-3 top-1/2 size-4 -translate-y-1/2 text-muted-foreground" />
            <Input
              id="search"
              type="text"
              placeholder="ì˜ˆ: ì‚¬ê³¼, ë°°ì¶”, ë ˆëª¬"
              value={searchKeyword}
              onChange={(e) => {
                setSearchKeyword(e.target.value);
                setSelectedProductCode(null);
              }}
              onFocus={() => {
                if (suggestions.length > 0) setShowSuggestions(true);
              }}
              className="pl-10"
            />
            {/* ğŸ†• ìë™ì™„ì„± ì œì•ˆ ëª©ë¡ */}
            {showSuggestions && suggestions.length > 0 && (
              <div className="absolute z-50 w-full mt-1 bg-popover border rounded-md shadow-lg max-h-60 overflow-auto">
                {suggestions.map((code) => (
                  <div
                    key={code.productNo}
                    onClick={() => handleSuggestionClick(code)}
                    className="p-3 hover:bg-accent cursor-pointer border-b last:border-b-0"
                  >
                    <div className="font-medium">{code.í’ˆëª©ëª…}</div>
                    <div className="text-xs text-muted-foreground">
                      {code.ëŒ€ë¶„ë¥˜ëª…} Â· {code.í‘œì‹œë‹¨ìœ„} Â· {code.ë‹¨ìœ„ëª…}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* ğŸ†• ë‹¨ìœ„ íƒ€ì… ì„ íƒ */}
        <div className="flex flex-col gap-2 md:w-32">
          <label htmlFor="unitType" className="text-sm font-medium">
            ë‹¨ìœ„ íƒ€ì…
          </label>
          <Select
            value={unitType}
            onValueChange={(value) => setUnitType(value as typeof unitType)}
          >
            <SelectTrigger id="unitType">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="ì „ì²´">ì „ì²´</SelectItem>
              <SelectItem value="ì†Œë§¤">ì†Œë§¤</SelectItem>
              <SelectItem value="ë„ë§¤">ë„ë§¤</SelectItem>
              <SelectItem value="ì†Œí¬ì¥">ì†Œí¬ì¥</SelectItem>
            </SelectContent>
          </Select>
        </div>

        {/* ğŸ†• ë“±ê¸‰ ì„ íƒ */}
        <div className="flex flex-col gap-2 md:w-32">
          <label htmlFor="grade" className="text-sm font-medium">
            ë“±ê¸‰
          </label>
          <Select value={gradeCode} onValueChange={setGradeCode}>
            <SelectTrigger id="grade">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="ì „ì²´">ì „ì²´</SelectItem>
              <SelectItem value="01">íŠ¹ê¸‰</SelectItem>
              <SelectItem value="02">ìƒí’ˆ</SelectItem>
              <SelectItem value="03">ì¤‘í’ˆ</SelectItem>
            </SelectContent>
          </Select>
        </div>

        {/* ì¡°íšŒ ë²„íŠ¼ */}
        <div className="flex flex-col gap-2">
          <label className="text-sm font-medium opacity-0">ë²„íŠ¼</label>
          <Button type="submit" disabled={isLoading} className="h-10 px-6">
            <Search className="mr-2 size-4" />
            {isLoading ? "ì¡°íšŒ ì¤‘..." : "ì‹œì„¸ ì¡°íšŒ"}
          </Button>
        </div>
      </div>
    </form>
  );
}
