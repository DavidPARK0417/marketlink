# 토스페이먼츠 결제 문제 분석 및 해결 방안

## 📋 문제 상황

**현재 상태:**

- 토스페이먼츠 공용 테스트 키 사용 중
- 테스트 결제는 성공적으로 완료됨 (결제창에서 결제 완료 확인)
- 하지만 Supabase DB의 `payments` 테이블과 `settlements` 테이블에 데이터가 저장되지 않음

## 🔍 문제 원인 분석

토스페이먼츠 MCP 문서와 현재 코드를 분석한 결과, 다음과 같은 문제를 발견했습니다:

### 1. 결제 승인 API 미호출

**토스페이먼츠 결제 흐름:**

```
1. 결제 요청 (requestPayment)
   ↓
2. 결제 인증 (사용자가 카드 정보 입력)
   ↓
3. 성공 URL로 리다이렉트 (paymentKey, orderId, amount 포함)
   ↓
4. ⚠️ 결제 승인 API 호출 필요 (현재 누락됨)
   ↓
5. 결제 승인 완료
   ↓
6. 웹훅 발송 (PAYMENT_STATUS_CHANGED 이벤트)
   ↓
7. DB 저장 (payments, settlements 테이블)
```

**현재 코드 상태:**

- `/api/payments/callback` 라우트는 웹훅을 받는 용도로만 구현됨
- 결제 승인 API(`POST /v1/payments/confirm`)를 호출하는 부분이 없음
- 결제 성공 URL에서 결제 승인을 처리하는 페이지/API가 없음

### 2. 웹훅 미등록 또는 미수신

**웹훅 동작 조건:**

- 웹훅은 결제 승인 후에만 발송됨
- 결제 승인 API를 호출하지 않으면 웹훅이 발송되지 않음
- 웹훅은 개발자센터에서 등록해야 함 (로컬 환경은 ngrok 필요)

**현재 상태:**

- 결제 승인 API를 호출하지 않으므로 웹훅이 발송되지 않음
- 따라서 `/api/payments/callback`이 호출되지 않음

## 💡 해결 방안

### 방안 1: 결제 승인 API 호출 추가 (권장)

**구현 방법:**

1. **결제 성공 페이지 생성**

   - 경로: `app/(retailer)/payments/success/page.tsx`
   - URL 쿼리 파라미터에서 `paymentKey`, `orderId`, `amount` 추출
   - 서버 액션 또는 API 라우트에서 결제 승인 API 호출

2. **결제 승인 API 라우트 생성**

   - 경로: `app/api/payments/confirm/route.ts`
   - 토스페이먼츠 결제 승인 API 호출
   - 승인 성공 시 DB 저장 (payments, settlements)

3. **결제 승인 API 호출 코드 예시:**

```typescript
// app/api/payments/confirm/route.ts
export async function POST(request: NextRequest) {
  const { paymentKey, orderId, amount } = await request.json();

  // 토스페이먼츠 결제 승인 API 호출
  const response = await fetch(
    "https://api.tosspayments.com/v1/payments/confirm",
    {
      method: "POST",
      headers: {
        Authorization: `Basic ${Buffer.from(
          `${process.env.TOSS_SECRET_KEY}:`,
        ).toString("base64")}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        paymentKey,
        orderId,
        amount,
      }),
    },
  );

  const paymentData = await response.json();

  // DB 저장 로직 (현재 /api/payments/callback의 로직 활용)
  // ...
}
```

**장점:**

- 토스페이먼츠 공식 가이드라인 준수
- 웹훅 없이도 즉시 DB 저장 가능
- 결제 승인 실패 시 즉시 에러 처리 가능

**단점:**

- 결제 승인 API와 DB 저장 로직을 분리해야 함

### 방안 2: 웹훅 등록 및 수신 (보조)

**구현 방법:**

1. **로컬 개발 환경:**

   - ngrok 설치 및 실행: `ngrok http 3000`
   - 토스페이먼츠 개발자센터에서 웹훅 등록
   - 웹훅 URL: `https://{ngrok-url}/api/payments/callback`
   - 이벤트 타입: `PAYMENT_STATUS_CHANGED`

2. **프로덕션 환경:**
   - 실제 도메인으로 웹훅 등록
   - HTTPS 필수

**장점:**

- 결제 상태 변경을 실시간으로 받을 수 있음
- 결제 취소, 환불 등도 자동 처리 가능

**단점:**

- 로컬 개발 환경 설정이 복잡함
- 웹훅 수신 실패 시 재전송 정책에 의존해야 함

### 방안 3: 하이브리드 방식 (최적)

**구현 방법:**

1. **결제 승인 API 호출 (방안 1)**

   - 결제 성공 시 즉시 결제 승인 API 호출
   - 승인 성공 시 DB 저장

2. **웹훅 등록 (방안 2)**
   - 프로덕션 환경에서 웹훅 등록
   - 결제 취소, 환불 등 추가 이벤트 처리

**장점:**

- 즉시 DB 저장 가능
- 추가 이벤트도 처리 가능
- 안정성 향상

## 🎯 권장 구현 순서

1. **1단계: 결제 승인 API 호출 구현**

   - 결제 성공 페이지 생성
   - 결제 승인 API 라우트 생성
   - DB 저장 로직 통합

2. **2단계: 테스트**

   - 테스트 결제 진행
   - DB 저장 확인
   - 에러 처리 확인

3. **3단계: 웹훅 등록 (선택)**
   - 프로덕션 환경에서 웹훅 등록
   - 결제 취소, 환불 처리 추가

## ❓ 멘토님께 질문드릴 사항

### 질문 1: 결제 승인 API 호출 시점

**질문:**
결제 성공 URL로 리다이렉트된 후, 결제 승인 API를 어디서 호출하는 것이 가장 적절한가요?

**옵션:**

- A) 클라이언트 컴포넌트에서 직접 호출 (보안 위험)
- B) 서버 액션에서 호출
- C) API 라우트에서 호출 (현재 권장)
- D) 다른 방법

**현재 고민:**

- 결제 승인 API는 시크릿 키가 필요하므로 서버 사이드에서만 호출해야 함
- 하지만 사용자 경험을 위해 빠른 응답이 필요함

### 질문 2: 결제 승인과 DB 저장의 분리

**질문:**
결제 승인 API 호출과 DB 저장 로직을 분리할지, 통합할지 어떻게 하는 것이 좋을까요?

**옵션:**

- A) 결제 승인 API 호출 후 즉시 DB 저장 (동기)
- B) 결제 승인 API 호출 후 웹훅으로 DB 저장 (비동기)
- C) 하이브리드: 결제 승인 후 즉시 저장 + 웹훅으로 재검증

**현재 고민:**

- 동기 방식은 빠르지만, 결제 승인 API 실패 시 롤백이 복잡함
- 비동기 방식은 안정적이지만, DB 저장 지연 가능

### 질문 3: 웹훅 등록 필요성

**질문:**
테스트 환경에서 웹훅을 등록하지 않고, 결제 승인 API만으로 처리해도 될까요?

**현재 상황:**

- 로컬 개발 환경에서 ngrok 설정이 번거로움
- 테스트 결제만 확인하면 되므로 웹훅이 필수는 아닐 수 있음

**고려사항:**

- 프로덕션 환경에서는 웹훅이 필요할 수 있음
- 결제 취소, 환불 등 추가 기능 구현 시 웹훅이 유용함

### 질문 4: 에러 처리 전략

**질문:**
결제 승인 API 호출 실패 시 어떻게 처리하는 것이 좋을까요?

**시나리오:**

- 결제 인증은 성공했지만, 승인 API 호출 실패
- 네트워크 오류, 서버 오류 등

**옵션:**

- A) 사용자에게 에러 메시지 표시, 재시도 버튼 제공
- B) 백그라운드에서 자동 재시도
- C) 관리자에게 알림 발송

### 질문 5: 현재 코드 구조 개선

**질문:**
현재 `/api/payments/callback` 라우트의 로직을 결제 승인 API 호출 후에도 재사용할 수 있을까요?

**현재 코드:**

- 웹훅 수신 전용으로 구현됨
- DB 저장 로직이 포함되어 있음

**제안:**

- DB 저장 로직을 공통 함수로 분리
- 결제 승인 API와 웹훅 모두에서 재사용

## 📚 참고 자료

- [토스페이먼츠 결제 승인 API 문서](https://docs.tosspayments.com/reference#%EA%B2%B0%EC%A0%9C-%EC%8A%B9%EC%9D%B8)
- [토스페이먼츠 웹훅 문서](https://docs.tosspayments.com/guides/webhook)
- [토스페이먼츠 결제 흐름 가이드](https://docs.tosspayments.com/guides/payment-widget/integration)

## 🎯 다음 단계

멘토님의 답변을 바탕으로:

1. 결제 승인 API 호출 구현
2. DB 저장 로직 통합
3. 에러 처리 추가
4. 테스트 진행
