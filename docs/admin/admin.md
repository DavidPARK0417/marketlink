# ğŸ‘¨â€ğŸ’¼ ê´€ë¦¬ì í˜ì´ì§€ ê°œë°œ ê°€ì´ë“œë¼ì¸

> **í”„ë¡œì íŠ¸ëª…**: AI ê¸°ë°˜ B2B ë„ë§¤-ì†Œë§¤ ì¤‘ê°œ í”Œë«í¼  
> **ë‹´ë‹¹**: ê´€ë¦¬ì í˜ì´ì§€ ê°œë°œ (ë„ë§¤ í”„ë¡œì íŠ¸ ë‚´)  
> **ê°œë°œ ë°©ì‹**: ì»¤ì„œ AI ë°”ì´ë¸Œ ì½”ë”©  
> **ëŒ€ìƒ**: ì´ˆë³´ ê°œë°œì  
> **ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-11-27

---

## ğŸ“‹ ëª©ì°¨

1. [ê°œìš”](#1-ê°œìš”)
2. [í”„ë¡œì íŠ¸ êµ¬ì¡° ì´í•´](#2-í”„ë¡œì íŠ¸-êµ¬ì¡°-ì´í•´)
3. [êµ¬í˜„ ì „ëµ](#3-êµ¬í˜„-ì „ëµ)
4. [í•µì‹¬ ê¸°ëŠ¥ êµ¬í˜„](#4-í•µì‹¬-ê¸°ëŠ¥-êµ¬í˜„)
5. [ë³´ì•ˆ ë° ê¶Œí•œ ê´€ë¦¬](#5-ë³´ì•ˆ-ë°-ê¶Œí•œ-ê´€ë¦¬)
6. [ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼](#6-ë°ì´í„°ë² ì´ìŠ¤-ì ‘ê·¼)
7. [ë°°í¬ ë° í…ŒìŠ¤íŠ¸](#7-ë°°í¬-ë°-í…ŒìŠ¤íŠ¸)
8. [ì°¸ê³  ìë£Œ](#8-ì°¸ê³ -ìë£Œ)

---

## 1. ê°œìš”

### 1.1 ê´€ë¦¬ì í˜ì´ì§€ë€?

ê´€ë¦¬ìê°€ í”Œë«í¼ ì „ì²´ë¥¼ ê´€ë¦¬í•˜ëŠ” í˜ì´ì§€ì…ë‹ˆë‹¤. ë„ë§¤ í”„ë¡œì íŠ¸ ë‚´ì— ìœ„ì¹˜í•˜ì§€ë§Œ, **ë„ë§¤ì™€ ì†Œë§¤ ëª¨ë‘ì˜ ë°ì´í„°ë¥¼ ê´€ë¦¬**í•©ë‹ˆë‹¤.

### 1.2 í•µì‹¬ ê¸°ëŠ¥ (MVP)

#### Phase 1 (í•„ìˆ˜) âœ…

- âœ… **ë„ë§¤ ìŠ¹ì¸/ë°˜ë ¤**: ë„ë§¤ì‚¬ì—…ì ê°€ì… ìš”ì²­ ì²˜ë¦¬
- âœ… **ë„ë§¤ ë¬¸ì˜ ê´€ë¦¬**: ë„ë§¤ì‚¬ì—…ì â†’ ê´€ë¦¬ì ë¬¸ì˜ ì¡°íšŒ ë° ë‹µë³€
- âœ… **ë„ë§¤ ê³„ì • ê´€ë¦¬**: ê³„ì • ì •ì§€/í•´ì œ
- âœ… **ì „ì²´ CS ì²˜ë¦¬**: ë„ë§¤ì™€ ì†Œë§¤ì˜ CS í†µí•© ê´€ë¦¬
- âœ… **í†µí•© ê°ì‚¬ ë¡œê·¸**: ëª¨ë“  ê´€ë¦¬ì ì•¡ì…˜ ì¶”ì 

#### Phase 2 (ì„ íƒ) ğŸ”µ

- ğŸ”µ **ì†Œë§¤ ê³„ì • ì¡°íšŒ**: ì†Œë§¤ ê³„ì • ëª©ë¡ ë° ìƒì„¸ ë³´ê¸°
- ğŸ”µ **ì „ì²´ ì£¼ë¬¸ ëª¨ë‹ˆí„°ë§**: ë„ë§¤-ì†Œë§¤ ê°„ ì£¼ë¬¸ í˜„í™©
- ğŸ”µ **í†µê³„ ëŒ€ì‹œë³´ë“œ**: í”Œë«í¼ ì „ì²´ í†µê³„
- ğŸ”µ **ìˆ˜ìˆ˜ë£Œìœ¨ ì„¤ì •**: í”Œë«í¼ ìˆ˜ìˆ˜ë£Œ ê´€ë¦¬

### 1.3 ì ‘ê·¼ ë°©ì‹

- **URL ì§ì ‘ ì ‘ì†**: `/admin` ê²½ë¡œë¡œ ì§ì ‘ ì ‘ì†
- **ë¡œê·¸ì¸**: Clerk ì¸ì¦ì„ í†µí•œ ë¡œê·¸ì¸
- **ê¶Œí•œ ì²´í¬**: `role='admin'`ì¸ ì‚¬ìš©ìë§Œ ì ‘ê·¼ ê°€ëŠ¥
- **ë³´ì•ˆ**: ë³„ë„ì˜ ê´€ë¦¬ì í˜ì´ì§€ ì ‘ê·¼ ë²„íŠ¼ ì—†ìŒ (URL ì§ì ‘ ì…ë ¥)

---

## 2. í”„ë¡œì íŠ¸ êµ¬ì¡° ì´í•´

### 2.1 3ê°œ ë„ë©”ì¸ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    í”„ë¡œì íŠ¸ ë¶„ë¦¬ êµ¬ì¡°                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1ï¸âƒ£ ë©”ì¸ ëœë”© í˜ì´ì§€ (ë³„ë„ ë„ë©”ì¸)
   â””â”€ www.marketlink.com
   â””â”€ ì—­í•  ì„ íƒ ë° ì•ˆë‚´

2ï¸âƒ£ ë„ë§¤ í”„ë¡œì íŠ¸ (ì´ í”„ë¡œì íŠ¸)
   â””â”€ wholesale.marketlink.com
   â”œâ”€ /wholesaler/* (ë„ë§¤ í˜ì´ì§€)
   â””â”€ /admin/* (ê´€ë¦¬ì í˜ì´ì§€) â­

3ï¸âƒ£ ì†Œë§¤ í”„ë¡œì íŠ¸ (ë³„ë„ íŒ€, ë³„ë„ ë„ë©”ì¸)
   â””â”€ retail.marketlink.com
   â””â”€ /retailer/* (ì†Œë§¤ í˜ì´ì§€)

ğŸ—„ï¸ Supabase DB (ê³µìœ )
   â””â”€ 3ê°œ í”„ë¡œì íŠ¸ê°€ ë™ì¼í•œ DB ì‚¬ìš©
```

### 2.2 ê´€ë¦¬ì í˜ì´ì§€ì˜ ìœ„ì¹˜

```
í˜„ì¬ í”„ë¡œì íŠ¸ (ë„ë§¤ ì „ìš©):
app/
â”œâ”€â”€ wholesaler/        # ë„ë§¤ í˜ì´ì§€
â”œâ”€â”€ admin/            # ğŸ‘¨â€ğŸ’¼ ê´€ë¦¬ì í˜ì´ì§€ (ì—¬ê¸°!)
â”‚   â”œâ”€â”€ layout.tsx    # ê´€ë¦¬ì ë ˆì´ì•„ì›ƒ (ê¶Œí•œ ì²´í¬)
â”‚   â”œâ”€â”€ dashboard/    # ëŒ€ì‹œë³´ë“œ
â”‚   â”œâ”€â”€ wholesalers/  # ë„ë§¤ ê´€ë¦¬
â”‚   â”‚   â”œâ”€â”€ pending/  # ìŠ¹ì¸ ëŒ€ê¸°
â”‚   â”‚   â””â”€â”€ [id]/     # ë„ë§¤ ìƒì„¸
â”‚   â”œâ”€â”€ cs/           # CS í†µí•© ê´€ë¦¬
â”‚   â””â”€â”€ audit-logs/   # ê°ì‚¬ ë¡œê·¸
â””â”€â”€ layout.tsx        # ë£¨íŠ¸ ë ˆì´ì•„ì›ƒ
```

### 2.3 ë°ì´í„° ì ‘ê·¼ ë°©ì‹

**âš ï¸ ì¤‘ìš”**: ê´€ë¦¬ìëŠ” **ë„ë§¤ í”„ë¡œì íŠ¸ ë‚´ì— ìˆì§€ë§Œ, ì†Œë§¤ ë°ì´í„°ë„ ì¡°íšŒ**í•´ì•¼ í•©ë‹ˆë‹¤.

**ë°©ì‹ A: ì§ì ‘ DB ì ‘ê·¼** (í˜„ì¬ ì±„íƒ âœ…)

```typescript
// ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì§ì ‘ Supabase ì ‘ê·¼
const supabase = createClerkSupabaseClient();

// ë„ë§¤ì™€ ì†Œë§¤ì˜ CSë¥¼ ëª¨ë‘ ì¡°íšŒ
const { data: csThreads } = await supabase
  .from("cs_threads")
  .select("*")
  .order("created_at", { ascending: false });
```

**ì¥ì **:

- âœ… êµ¬í˜„ì´ ê°„ë‹¨í•¨
- âœ… ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ íŒ¨í„´
- âœ… Supabase RLSë¡œ ë³´ì•ˆ ë³´ì¥
- âœ… ì´ˆë³´ì ì¹œí™”ì 

**ë‹¨ì **:

- âš ï¸ ì†Œë§¤ íŒ€ê³¼ DB ìŠ¤í‚¤ë§ˆ í˜‘ì˜ í•„ìš”
- âš ï¸ íƒ€ì… ì •ì˜ ë™ê¸°í™” í•„ìš”

**ë°©ì‹ B: í†µí•© API ê²Œì´íŠ¸ì›¨ì´** (Phase 2ì—ì„œ ê³ ë ¤ ğŸ”µ)

```typescript
// ë³„ë„ API ì„œë²„ë¥¼ í†µí•´ ì ‘ê·¼
const response = await fetch("http://api-gateway/admin/cs");
const csThreads = await response.json();
```

**ì¥ì **:

- âœ… í™•ì¥ì„± ì¢‹ìŒ
- âœ… ì†Œë§¤/ë„ë§¤ í”„ë¡œì íŠ¸ì™€ ì™„ì „ ë¶„ë¦¬

**ë‹¨ì **:

- âŒ êµ¬í˜„ ë³µì¡ë„ ë†’ìŒ
- âŒ ì¶”ê°€ ì„œë²„ ê´€ë¦¬ í•„ìš”
- âŒ í˜„ì¬ ê¸°ëŠ¥ì—ëŠ” ê³¼í•œ íˆ¬ì

---

## 3. êµ¬í˜„ ì „ëµ

### 3.1 ë‹¨ê³„ì  ì ‘ê·¼

```
Phase 1: ë„ë§¤ ê´€ë¦¬ + ê¸°ë³¸ í†µí•© ê¸°ëŠ¥ (2-3ì£¼)
â”œâ”€â”€ âœ… ë„ë§¤ ìŠ¹ì¸/ë°˜ë ¤ (ì´ë¯¸ ì™„ë£Œ)
â”œâ”€â”€ [ ] ë„ë§¤ ê³„ì • ì •ì§€/í•´ì œ
â”œâ”€â”€ [ ] ì „ì²´ CS ì²˜ë¦¬
â””â”€â”€ [ ] í†µí•© ê°ì‚¬ ë¡œê·¸

Phase 2: í™•ì¥ ê¸°ëŠ¥ (ì„ íƒ, 1-2ì£¼)
â”œâ”€â”€ [ ] ì†Œë§¤ ê³„ì • ì¡°íšŒ
â”œâ”€â”€ [ ] ì „ì²´ ì£¼ë¬¸ ëª¨ë‹ˆí„°ë§
â”œâ”€â”€ [ ] í†µê³„ ëŒ€ì‹œë³´ë“œ
â””â”€â”€ [ ] ìˆ˜ìˆ˜ë£Œìœ¨ ì„¤ì •

Phase 3: API ê²Œì´íŠ¸ì›¨ì´ (ì„ íƒ, 3-4ì£¼)
â””â”€â”€ [ ] í•„ìš” ì‹œ ë³„ë„ API ì„œë²„ êµ¬ì¶•
```

### 3.2 ìš°ì„ ìˆœìœ„

**ğŸ”´ ìµœìš°ì„  (Phase 1)**:

1. ë„ë§¤ ìŠ¹ì¸/ë°˜ë ¤ âœ… (ì™„ë£Œ)
2. ë„ë§¤ ê³„ì • ì •ì§€/í•´ì œ
3. ì „ì²´ CS ì²˜ë¦¬
4. í†µí•© ê°ì‚¬ ë¡œê·¸

**ğŸŸ¡ ì¤‘ìš” (Phase 2)**: 5. ì†Œë§¤ ê³„ì • ì¡°íšŒ 6. ì „ì²´ ì£¼ë¬¸ ëª¨ë‹ˆí„°ë§

**ğŸ”µ ì„ íƒ (Phase 2+)**: 7. í†µê³„ ëŒ€ì‹œë³´ë“œ 8. ìˆ˜ìˆ˜ë£Œìœ¨ ì„¤ì •

---

## 4. í•µì‹¬ ê¸°ëŠ¥ êµ¬í˜„

### 4.1 ê´€ë¦¬ì ê¶Œí•œ ì²´í¬ âœ… (ì™„ë£Œ)

**íŒŒì¼**: `lib/clerk/auth.ts`

ê´€ë¦¬ì í˜ì´ì§€ì˜ ëª¨ë“  í˜ì´ì§€ëŠ” `requireAdmin()` í•¨ìˆ˜ë¡œ ë³´í˜¸ë©ë‹ˆë‹¤.

```typescript
/**
 * ê´€ë¦¬ì ê¶Œí•œ í•„ìˆ˜ ê²€ì¦
 */
export async function requireAdmin(): Promise<ProfileWithDetails> {
  const profile = await requireAuth();

  if (profile.role !== "admin") {
    console.log("ğŸš« [auth] requireAdmin: ê´€ë¦¬ì ê¶Œí•œ ì—†ìŒ, ë¦¬ë‹¤ì´ë ‰íŠ¸");
    redirect("/");
  }

  return profile;
}
```

**ì‚¬ìš© ì˜ˆì‹œ**:

```typescript
// app/admin/dashboard/page.tsx
export default async function AdminDashboard() {
  const profile = await requireAdmin(); // ê´€ë¦¬ì ì²´í¬

  // ì—¬ê¸°ì„œëŠ” í•­ìƒ ê´€ë¦¬ì
  return <div>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</div>;
}
```

---

### 4.2 ê´€ë¦¬ì ë ˆì´ì•„ì›ƒ âœ… (ì™„ë£Œ)

**íŒŒì¼**: `app/admin/layout.tsx`

ëª¨ë“  ê´€ë¦¬ì í˜ì´ì§€ë¥¼ ê°ì‹¸ëŠ” ë ˆì´ì•„ì›ƒìœ¼ë¡œ, ë ˆì´ì•„ì›ƒ ë ˆë²¨ì—ì„œ ê¶Œí•œì„ ì²´í¬í•©ë‹ˆë‹¤.

**ì£¼ìš” ê¸°ëŠ¥**:

- âœ… `requireAdmin()`ìœ¼ë¡œ ê¶Œí•œ ì²´í¬
- âœ… ê´€ë¦¬ì ì „ìš© ë„¤ë¹„ê²Œì´ì…˜
- âœ… ê¹”ë”í•œ ê´€ë¦¬ì UI

**ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´**:

- ëŒ€ì‹œë³´ë“œ (`/admin/dashboard`)
- ë„ë§¤ ìŠ¹ì¸ ëŒ€ê¸° (`/admin/wholesalers/pending`)
- ë„ë§¤ ë¬¸ì˜ ê´€ë¦¬ (`/admin/inquiries`) âœ…
- CS ê´€ë¦¬ (`/admin/cs`)
- ê°ì‚¬ ë¡œê·¸ (`/admin/audit-logs`)

---

### 4.3 ë„ë§¤ ìŠ¹ì¸/ë°˜ë ¤ âœ… (ì™„ë£Œ)

#### 4.3.1 ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡

**íŒŒì¼**: `app/admin/wholesalers/pending/page.tsx`

```typescript
export default async function PendingWholesalersPage() {
  await requireAdmin();

  const supabase = createClerkSupabaseClient();

  // status='pending'ì¸ ë„ë§¤ì‚¬ì—…ì ì¡°íšŒ
  const { data: wholesalers, error } = await supabase
    .from("wholesalers")
    .select(
      `
      id,
      business_name,
      business_number,
      representative,
      phone,
      created_at,
      profiles!inner (
        email
      )
    `,
    )
    .eq("status", "pending")
    .order("created_at", { ascending: false });

  // UI ë Œë”ë§...
}
```

#### 4.3.2 ìŠ¹ì¸/ë°˜ë ¤ Server Action

**íŒŒì¼**: `actions/admin/wholesaler-approval.ts`

```typescript
"use server";

import { createClerkSupabaseClient } from "@/lib/supabase/server";
import { getServiceRoleClient } from "@/lib/supabase/service-role";
import { headers } from "next/headers";

/**
 * ë„ë§¤ì‚¬ì—…ì ìŠ¹ì¸
 */
export async function approveWholesaler(wholesalerId: string, adminId: string) {
  const supabase = getServiceRoleClient();
  const ipAddress = await getIpAddress();

  // ìŠ¹ì¸ ì²˜ë¦¬
  await supabase
    .from("wholesalers")
    .update({
      status: "approved",
      approved_at: new Date().toISOString(),
    })
    .eq("id", wholesalerId);

  // ê°ì‚¬ ë¡œê·¸ ê¸°ë¡
  await supabase.from("audit_logs").insert({
    user_id: adminId,
    action: "wholesaler_approve",
    target_type: "wholesaler",
    target_id: wholesalerId,
    ip_address: ipAddress,
  });

  revalidatePath("/admin/wholesalers/pending");
  redirect("/admin/wholesalers/pending");
}
```

---

### 4.4 ë„ë§¤ ê³„ì • ì •ì§€/í•´ì œ (êµ¬í˜„ ì˜ˆì •)

**ëª©ì **: ë¬¸ì œê°€ ìˆëŠ” ë„ë§¤ì‚¬ì—…ìì˜ ê³„ì •ì„ ì •ì§€í•˜ê±°ë‚˜ í•´ì œ

**íŒŒì¼**: `actions/admin/account-management.ts`

**ì»¤ì„œ AI í”„ë¡¬í”„íŠ¸:**

```
ë„ë§¤ ê³„ì • ì •ì§€/í•´ì œ Server Actionì„ ë§Œë“¤ì–´ì¤˜.

ìš”êµ¬ì‚¬í•­:
- suspendWholesaler() í•¨ìˆ˜: status='suspended'ë¡œ ë³€ê²½
- unsuspendWholesaler() í•¨ìˆ˜: status='approved'ë¡œ ë³µêµ¬
- ì •ì§€ ì‚¬ìœ  ì…ë ¥ (suspension_reason)
- audit_logsì— ê¸°ë¡
- IP ì£¼ì†Œ ì¶”ì¶œ ë° ê¸°ë¡

íŒŒì¼: actions/admin/account-management.ts
```

**ì˜ˆìƒ êµ¬ì¡°**:

```typescript
"use server";

/**
 * ë„ë§¤ ê³„ì • ì •ì§€
 */
export async function suspendWholesaler(
  wholesalerId: string,
  adminId: string,
  suspensionReason: string,
) {
  // 1. wholesalers.status = 'suspended'
  // 2. suspension_reason ì €ì¥
  // 3. audit_logs ê¸°ë¡
  // 4. ë¦¬ë‹¤ì´ë ‰íŠ¸
}

/**
 * ë„ë§¤ ê³„ì • ì •ì§€ í•´ì œ
 */
export async function unsuspendWholesaler(
  wholesalerId: string,
  adminId: string,
) {
  // 1. wholesalers.status = 'approved'
  // 2. suspension_reason = null
  // 3. audit_logs ê¸°ë¡
  // 4. ë¦¬ë‹¤ì´ë ‰íŠ¸
}
```

---

### 4.5 ë„ë§¤ ë¬¸ì˜ ê´€ë¦¬ âœ… (ì™„ë£Œ)

**ëª©ì **: ë„ë§¤ì‚¬ì—…ìê°€ ê´€ë¦¬ìì—ê²Œ ë³´ë‚¸ ë¬¸ì˜ë¥¼ ì¡°íšŒí•˜ê³  ë‹µë³€

#### 4.5.1 ë¬¸ì˜ ëª©ë¡ í˜ì´ì§€

**íŒŒì¼**: `app/admin/inquiries/page.tsx`

ê´€ë¦¬ìê°€ ëª¨ë“  ë„ë§¤ì‚¬ì—…ìë¡œë¶€í„° ë°›ì€ ë¬¸ì˜ë¥¼ ì¡°íšŒí•˜ëŠ” í˜ì´ì§€ì…ë‹ˆë‹¤.

**ì£¼ìš” ê¸°ëŠ¥**:

- ëª¨ë“  ë„ë§¤â†’ê´€ë¦¬ì ë¬¸ì˜ ëª©ë¡ ì¡°íšŒ (`getInquiriesForAdmin()`)
- ìƒíƒœë³„ í•„í„°ë§ (ì „ì²´/ë¯¸ë‹µë³€/ë‹µë³€ì™„ë£Œ/ì¢…ë£Œ)
- ë‚ ì§œ ë²”ìœ„ ë° ê²€ìƒ‰ í•„í„°
- ë¬¸ì˜ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™

**êµ¬í˜„ ë‚´ìš©**:

```typescript
// lib/supabase/queries/inquiries.ts
export async function getInquiriesForAdmin(
  options: GetInquiriesOptions = {},
): Promise<GetInquiriesResult> {
  // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
  // inquiry_type = 'wholesaler_to_admin' í•„í„°
  // ë„ë§¤ì‚¬ì—…ì ìµëª… ì½”ë“œ í¬í•¨
  // í˜ì´ì§€ë„¤ì´ì…˜ ë° ì •ë ¬
}
```

#### 4.5.2 ë¬¸ì˜ ìƒì„¸ ë° ë‹µë³€ í˜ì´ì§€

**íŒŒì¼**: `app/admin/inquiries/[id]/page.tsx`

**ì£¼ìš” ê¸°ëŠ¥**:

- ë¬¸ì˜ ìƒì„¸ ì •ë³´ í‘œì‹œ (ì œëª©, ë‚´ìš©, ë¬¸ì˜ì¼, ë„ë§¤ì‚¬ì—…ì ìµëª… ì½”ë“œ)
- ê¸°ì¡´ ë‹µë³€ í‘œì‹œ
- ë‹µë³€ ì‘ì„± í¼ (statusê°€ 'open'ì¸ ê²½ìš°ë§Œ)
- ë‹µë³€ ì‘ì„± ì‹œ ìƒíƒœê°€ 'answered'ë¡œ ë³€ê²½

**API ì—”ë“œí¬ì¸íŠ¸**:

- `GET /api/admin/inquiries/[id]`: ë¬¸ì˜ ìƒì„¸ ì¡°íšŒ
- `POST /api/admin/inquiries/reply`: ë‹µë³€ ì‘ì„±

**ì‚¬ìš© ì»´í¬ë„ŒíŠ¸**:

- `InquiryTable`: ë¬¸ì˜ ëª©ë¡ í…Œì´ë¸” (ì¬ì‚¬ìš©)
- `InquiryFilter`: í•„í„° UI (ì¬ì‚¬ìš©)
- `InquiryReplyForm`: ë‹µë³€ ì‘ì„± í¼ (ì¬ì‚¬ìš©, `apiEndpoint` propìœ¼ë¡œ ê´€ë¦¬ììš© API ì§€ì •)

---

### 4.6 ì „ì²´ CS ì²˜ë¦¬ (êµ¬í˜„ ì˜ˆì •)

**ëª©ì **: ë„ë§¤ì™€ ì†Œë§¤ì˜ CSë¥¼ í†µí•© ê´€ë¦¬

#### 4.5.1 CS ëª©ë¡ ì¡°íšŒ

**íŒŒì¼**: `app/admin/cs/page.tsx`

**ì»¤ì„œ AI í”„ë¡¬í”„íŠ¸:**

```
ê´€ë¦¬ì CS í†µí•© ê´€ë¦¬ í˜ì´ì§€ë¥¼ ë§Œë“¤ì–´ì¤˜.

ìš”êµ¬ì‚¬í•­:
- cs_threads í…Œì´ë¸”ì—ì„œ ëª¨ë“  ìŠ¤ë ˆë“œ ì¡°íšŒ
- profiles í…Œì´ë¸”ê³¼ ì¡°ì¸í•˜ì—¬ ì‚¬ìš©ì ì •ë³´ í¬í•¨
- ìƒíƒœë³„ í•„í„° (open, bot_handled, escalated, closed)
- ì—­í• ë³„ í•„í„° (wholesaler, retailer)
- í…Œì´ë¸” í˜•íƒœë¡œ í‘œì‹œ
- ê° í–‰ í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™

íŒŒì¼: app/admin/cs/page.tsx
```

**êµ¬í˜„ ì˜ˆì‹œ**:

```typescript
export default async function AdminCSPage() {
  await requireAdmin();

  const supabase = createClerkSupabaseClient();

  // ëª¨ë“  CS ìŠ¤ë ˆë“œ ì¡°íšŒ
  const { data: csThreads } = await supabase
    .from("cs_threads")
    .select(
      `
      id,
      title,
      status,
      created_at,
      profiles!inner (
        id,
        email,
        role
      )
    `,
    )
    .order("created_at", { ascending: false });

  return (
    <div>
      <h1>CS ê´€ë¦¬</h1>
      <CSThreadsTable threads={csThreads} />
    </div>
  );
}
```

#### 4.5.2 CS ìƒì„¸ ë° ë‹µë³€

**íŒŒì¼**: `app/admin/cs/[id]/page.tsx`

**ê¸°ëŠ¥**:

- CS ìŠ¤ë ˆë“œ ìƒì„¸ ì¡°íšŒ
- ëŒ€í™” ì´ë ¥ í‘œì‹œ
- ê´€ë¦¬ì ë‹µë³€ ì‘ì„±
- í‹°ì¼“ ìƒíƒœ ë³€ê²½ (open â†’ answered â†’ closed)

---

### 4.7 í†µí•© ê°ì‚¬ ë¡œê·¸ (êµ¬í˜„ ì˜ˆì •)

**ëª©ì **: ëª¨ë“  ê´€ë¦¬ì ì•¡ì…˜ì„ ì¶”ì í•˜ê³  ì¡°íšŒ

**íŒŒì¼**: `app/admin/audit-logs/page.tsx`

**ì»¤ì„œ AI í”„ë¡¬í”„íŠ¸:**

```
ê°ì‚¬ ë¡œê·¸ ì¡°íšŒ í˜ì´ì§€ë¥¼ ë§Œë“¤ì–´ì¤˜.

ìš”êµ¬ì‚¬í•­:
- audit_logs í…Œì´ë¸”ì—ì„œ ëª¨ë“  ë¡œê·¸ ì¡°íšŒ
- profiles í…Œì´ë¸”ê³¼ ì¡°ì¸í•˜ì—¬ ê´€ë¦¬ì ì •ë³´ í¬í•¨
- í•„í„°:
  - ì•¡ì…˜ ìœ í˜• (wholesaler_approve, wholesaler_reject, account_suspend ë“±)
  - ë‚ ì§œ ë²”ìœ„
  - ê´€ë¦¬ì (user_id)
- ì •ë ¬: created_at DESC
- ë¡œê·¸ ìƒì„¸ ë³´ê¸° (details JSONB)
- IP ì£¼ì†Œ í‘œì‹œ

íŒŒì¼: app/admin/audit-logs/page.tsx
```

**êµ¬í˜„ ì˜ˆì‹œ**:

```typescript
export default async function AuditLogsPage() {
  await requireAdmin();

  const supabase = createClerkSupabaseClient();

  // ê°ì‚¬ ë¡œê·¸ ì¡°íšŒ
  const { data: logs } = await supabase
    .from("audit_logs")
    .select(
      `
      id,
      action,
      target_type,
      target_id,
      details,
      ip_address,
      created_at,
      profiles!inner (
        email
      )
    `,
    )
    .order("created_at", { ascending: false })
    .limit(100);

  return (
    <div>
      <h1>ê°ì‚¬ ë¡œê·¸</h1>
      <AuditLogsTable logs={logs} />
    </div>
  );
}
```

---

## 5. ë³´ì•ˆ ë° ê¶Œí•œ ê´€ë¦¬

### 5.1 ê´€ë¦¬ì ê³„ì • ìƒì„± (ìˆ˜ë™)

**âš ï¸ ì¤‘ìš”**: ê´€ë¦¬ì ê³„ì •ì€ **ìˆ˜ë™ìœ¼ë¡œë§Œ ìƒì„±**í•´ì•¼ í•©ë‹ˆë‹¤.

#### Step 1: Clerkì—ì„œ ê³„ì • ìƒì„±

1. [Clerk ëŒ€ì‹œë³´ë“œ](https://dashboard.clerk.com) ì ‘ì†
2. Users ë©”ë‰´ì—ì„œ ìƒˆ ì‚¬ìš©ì ìƒì„±
3. ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¡œ ê³„ì • ìƒì„±
4. ìƒì„±ëœ ì‚¬ìš©ìì˜ `User ID` ë³µì‚¬ (ì˜ˆ: `user_2abc123...`)

#### Step 2: Supabaseì—ì„œ í”„ë¡œí•„ ìƒì„±

Supabase ëŒ€ì‹œë³´ë“œì˜ SQL Editorì—ì„œ ì‹¤í–‰:

```sql
-- ê´€ë¦¬ì í”„ë¡œí•„ ìƒì„±
INSERT INTO profiles (clerk_user_id, email, role, status)
VALUES (
  'user_2abc123...',  -- Clerk User ID
  'admin@marketlink.com',
  'admin',
  'active'
);
```

#### Step 3: ì ‘ê·¼ í…ŒìŠ¤íŠ¸

1. `/admin` ê²½ë¡œë¡œ ì ‘ì†
2. Clerk ë¡œê·¸ì¸ í™”ë©´ì—ì„œ ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
3. ê´€ë¦¬ì í˜ì´ì§€ ì ‘ê·¼ í™•ì¸

---

### 5.2 RLS ì •ì±…

**ëª¨ë“  ê´€ë¦¬ì ì¿¼ë¦¬ëŠ” Supabase RLS ì •ì±…ìœ¼ë¡œ ë³´í˜¸ë©ë‹ˆë‹¤.**

#### ì˜ˆì‹œ: `cs_threads` í…Œì´ë¸”

```sql
-- ê´€ë¦¬ìëŠ” ëª¨ë“  CS ìŠ¤ë ˆë“œ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Admins can view all CS threads"
ON cs_threads FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM profiles
    WHERE clerk_user_id = auth.jwt() ->> 'sub'
    AND role = 'admin'
  )
);

-- ê´€ë¦¬ìëŠ” ëª¨ë“  CS ìŠ¤ë ˆë“œ ìˆ˜ì • ê°€ëŠ¥
CREATE POLICY "Admins can update all CS threads"
ON cs_threads FOR UPDATE
USING (
  EXISTS (
    SELECT 1 FROM profiles
    WHERE clerk_user_id = auth.jwt() ->> 'sub'
    AND role = 'admin'
  )
);
```

#### ì˜ˆì‹œ: `audit_logs` í…Œì´ë¸”

```sql
-- ê´€ë¦¬ìë§Œ ê°ì‚¬ ë¡œê·¸ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Admins can view audit logs"
ON audit_logs FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM profiles
    WHERE clerk_user_id = auth.jwt() ->> 'sub'
    AND role = 'admin'
  )
);
```

---

### 5.3 IP ì£¼ì†Œ ì¶”ì¶œ

**ëª¨ë“  ê´€ë¦¬ì ì•¡ì…˜ì— IP ì£¼ì†Œë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.**

```typescript
// actions/admin/*.ts
async function getIpAddress(): Promise<string> {
  const headersList = await headers();

  // í”„ë¡ì‹œ í™˜ê²½ ê³ ë ¤
  const ipAddress =
    headersList.get("x-forwarded-for")?.split(",")[0] ||
    headersList.get("x-real-ip") ||
    "unknown";

  return ipAddress;
}
```

---

## 6. ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼

### 6.1 Supabase í´ë¼ì´ì–¸íŠ¸ ì„ íƒ

ê´€ë¦¬ì í˜ì´ì§€ì—ì„œëŠ” **ë‘ ê°€ì§€ í´ë¼ì´ì–¸íŠ¸**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:

#### A. Clerk ì¸ì¦ í´ë¼ì´ì–¸íŠ¸ (ì½ê¸° ì‘ì—…)

```typescript
import { createClerkSupabaseClient } from "@/lib/supabase/server";

// RLS ì •ì±…ì´ ì ìš©ë¨ (admin ê¶Œí•œ ì²´í¬)
const supabase = createClerkSupabaseClient();

const { data } = await supabase.from("cs_threads").select("*");
```

**ì‚¬ìš© ì‹œì **:

- ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ë°ì´í„° ì¡°íšŒ
- RLS ì •ì±…ìœ¼ë¡œ ë³´ì•ˆ ë³´ì¥

#### B. Service Role í´ë¼ì´ì–¸íŠ¸ (ì“°ê¸° ì‘ì—…)

```typescript
import { getServiceRoleClient } from "@/lib/supabase/service-role";

// RLS ì •ì±… ìš°íšŒ (ì£¼ì˜í•´ì„œ ì‚¬ìš©)
const supabase = getServiceRoleClient();

await supabase
  .from("wholesalers")
  .update({ status: "approved" })
  .eq("id", wholesalerId);
```

**ì‚¬ìš© ì‹œì **:

- Server Actionì—ì„œ ë°ì´í„° ìˆ˜ì •
- RLS ì •ì±…ì´ ë³µì¡í•  ë•Œ

**âš ï¸ ì£¼ì˜**: Service Roleì€ RLSë¥¼ ìš°íšŒí•˜ë¯€ë¡œ ì‹ ì¤‘í•˜ê²Œ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

---

### 6.2 ì†Œë§¤ íŒ€ê³¼ í˜‘ì—…

**ê´€ë¦¬ì í˜ì´ì§€ëŠ” ì†Œë§¤ ë°ì´í„°ë„ ì¡°íšŒí•˜ë¯€ë¡œ, ì†Œë§¤ íŒ€ê³¼ í˜‘ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.**

#### í˜‘ì˜ í•„ìš” ì‚¬í•­

1. **í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ**:

   - `cs_threads`, `cs_messages`
   - `audit_logs`
   - `retailers` (ì„ íƒ)

2. **íƒ€ì… ì •ì˜ ë™ê¸°í™”**:

   ```typescript
   // types/cs.ts (ê³µìœ )
   export interface CSThread {
     id: string;
     user_id: string;
     title: string;
     status: "open" | "bot_handled" | "escalated" | "closed";
     created_at: string;
   }
   ```

3. **RLS ì •ì±…**:
   - ì†Œë§¤ í”„ë¡œì íŠ¸ì—ì„œë„ ê´€ë¦¬ì ê¶Œí•œ ì¸ì‹
   - `profiles.role = 'admin'` ì²´í¬

---

## 7. ë°°í¬ ë° í…ŒìŠ¤íŠ¸

### 7.1 í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

#### ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸

- [ ] ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ ì‹œ ê´€ë¦¬ì í˜ì´ì§€ ì ‘ê·¼ ê°€ëŠ¥
- [ ] ë¹„ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ì ‘ê·¼ ì‹œ í™ˆìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
- [ ] ë„ë§¤ ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ì´ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë¨
- [ ] ë„ë§¤ ìŠ¹ì¸/ë°˜ë ¤ê°€ ì •ìƒ ì‘ë™í•¨
- [ ] CS ëª©ë¡ì´ ë„ë§¤ì™€ ì†Œë§¤ í†µí•© ì¡°íšŒë¨
- [ ] ê°ì‚¬ ë¡œê·¸ê°€ ì •ìƒì ìœ¼ë¡œ ê¸°ë¡ë¨

#### ë³´ì•ˆ í…ŒìŠ¤íŠ¸

- [ ] ëª¨ë“  `/admin/*` ê²½ë¡œê°€ `requireAdmin()`ìœ¼ë¡œ ë³´í˜¸ë¨
- [ ] Server Actionì—ì„œë„ ê¶Œí•œ ì¬í™•ì¸ë¨
- [ ] ë¹„ê´€ë¦¬ì ì ‘ê·¼ ì‹œ ì ì ˆíˆ ì°¨ë‹¨ë¨
- [ ] RLS ì •ì±…ì´ ì •ìƒ ì‘ë™í•¨

#### í†µí•© í…ŒìŠ¤íŠ¸

- [ ] ë„ë§¤ì‚¬ì—…ì ìŠ¹ì¸ í›„ ë¡œê·¸ì¸ ê°€ëŠ¥
- [ ] CS ë‹µë³€ ì‘ì„± í›„ ì‚¬ìš©ìê°€ í™•ì¸ ê°€ëŠ¥
- [ ] ê°ì‚¬ ë¡œê·¸ì— ëª¨ë“  ì•¡ì…˜ ê¸°ë¡ë¨

---

### 7.2 ë°°í¬ ì¤€ë¹„

#### í™˜ê²½ ë³€ìˆ˜ í™•ì¸

```bash
# .env.local
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=ey...
SUPABASE_SERVICE_ROLE_KEY=ey...

NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
```

#### í”„ë¡œë•ì…˜ ë°°í¬ ì „

1. **ê´€ë¦¬ì ê³„ì • ìƒì„±** (í”„ë¡œë•ì…˜ Clerk + Supabase)
2. **RLS ì •ì±… í™•ì¸** (ëª¨ë“  í…Œì´ë¸”)
3. **IP ì£¼ì†Œ ì¶”ì¶œ í…ŒìŠ¤íŠ¸** (í”„ë¡ì‹œ í™˜ê²½)
4. **ê°ì‚¬ ë¡œê·¸ ê¸°ë¡ í™•ì¸**

---

## 8. ì°¸ê³  ìë£Œ

### 8.1 ê´€ë ¨ ë¬¸ì„œ

- [ë„ë§¤ í˜ì´ì§€ ê°€ì´ë“œë¼ì¸](../Wholesaler/WS_Guideline.md)
- [ë„ë§¤ í˜ì´ì§€ TODO](../Wholesaler/WS_TODO.md)
- [PRD ë¬¸ì„œ](../PRD.md)
- [í†µí•© ê²Œì´íŠ¸ì›¨ì´ ì„¤ëª…](./í†µí•©ê²Œì´íŠ¸ì›¨ì´.md)

### 8.2 ì™¸ë¶€ ë¬¸ì„œ

- [Clerk ë¬¸ì„œ](https://clerk.com/docs)
- [Supabase ë¬¸ì„œ](https://supabase.com/docs)
- [Next.js ë¬¸ì„œ](https://nextjs.org/docs)
- [Supabase RLS ê°€ì´ë“œ](https://supabase.com/docs/guides/auth/row-level-security)

---

## ë¶€ë¡: ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ (FAQ)

### Q1: ì†Œë§¤ í”„ë¡œì íŠ¸ì™€ ì–´ë–»ê²Œ í˜‘ì—…í•˜ë‚˜ìš”?

**A**: Supabase DBë¥¼ ê³µìœ í•˜ë¯€ë¡œ, í…Œì´ë¸” ìŠ¤í‚¤ë§ˆì™€ RLS ì •ì±…ì„ í˜‘ì˜í•´ì•¼ í•©ë‹ˆë‹¤.

1. ì†Œë§¤ íŒ€ì—ê²Œ ê´€ë¦¬ìê°€ ì ‘ê·¼í•  í…Œì´ë¸” ëª©ë¡ ê³µìœ 
2. RLS ì •ì±…ì— `role = 'admin'` ì¡°ê±´ ì¶”ê°€ ìš”ì²­
3. íƒ€ì… ì •ì˜ íŒŒì¼ ê³µìœ  (ì˜ˆ: `types/cs.ts`)

### Q2: í†µí•© API ê²Œì´íŠ¸ì›¨ì´ëŠ” ì–¸ì œ í•„ìš”í•œê°€ìš”?

**A**: ë‹¤ìŒ ìƒí™©ì—ì„œ ê³ ë ¤í•˜ì„¸ìš”:

- ì†Œë§¤ í”„ë¡œì íŠ¸ì™€ ì™„ì „íˆ ë¶„ë¦¬í•´ì•¼ í•  ë•Œ
- íŠ¸ë˜í”½ì´ ë§ì•„ì ¸ì„œ ì„±ëŠ¥ ìµœì í™”ê°€ í•„ìš”í•  ë•Œ
- ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì¤‘ì•™ì—ì„œ ê´€ë¦¬í•´ì•¼ í•  ë•Œ

**í˜„ì¬ëŠ” ì§ì ‘ DB ì ‘ê·¼ìœ¼ë¡œ ì¶©ë¶„í•©ë‹ˆë‹¤.**

### Q3: ê´€ë¦¬ì ê³„ì •ì„ ìë™ìœ¼ë¡œ ìƒì„±í•  ìˆ˜ ì—†ë‚˜ìš”?

**A**: ë³´ì•ˆìƒ ê¶Œì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

- ê´€ë¦¬ì ê³„ì •ì€ ìˆ˜ë™ìœ¼ë¡œë§Œ ìƒì„±
- í”„ë¡œë•ì…˜ì—ì„œëŠ” ë”ìš± ì—„ê²©í•˜ê²Œ ê´€ë¦¬
- í•„ìš” ì‹œ ë³„ë„ì˜ ìŠ¹ì¸ í”„ë¡œì„¸ìŠ¤ êµ¬ì¶•

---

**ì‘ì„±ì¼**: 2025-11-27  
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-11-28  
**ì‘ì„±ì**: AI Assistant  
**ë²„ì „**: v1.1 (ë„ë§¤ ë¬¸ì˜ ê´€ë¦¬ ê¸°ëŠ¥ ì¶”ê°€)
